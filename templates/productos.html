{% load static %}
{% load humanize %} 
<!DOCTYPE html>
<html>
<head>
  <!-- Basic -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <!-- Mobile Metas -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <!-- Site Metas -->
  <meta name="keywords" content="" />
  <meta name="description" content="" />
  <meta name="author" content="" />
  <title>SanrioDreams - Tienda de art√≠culos</title>
  <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.css' %}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.5.9/slick.min.css"  />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.5.9/slick-theme.min.css"  />
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,600,700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/slick-theme.css' %}" />
  <link href="{% static 'css/font-awesome.min.css' %}" rel="stylesheet" />
  <link href="{% static 'css/style.css' %}" rel="stylesheet" />
  <link href="{% static 'css/responsive.css' %}" rel="stylesheet" />
</head>
<body>
  <div class="main_body_content">
    <div class="hero_area">
      <!-- Header Inicio -->
      <header class="header_section">
        <div class="container-fluid">
          <nav class="navbar navbar-expand-lg custom_nav-container">
            <a class="navbar-brand" href="{% url 'index' %}">
              SanrioDreams
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse"
              data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" 
              aria-expanded="false" aria-label="Toggle navigation">
              <span class=""></span>
            </button>

            <!-- Bot√≥n simple y elegante para cambiar moneda -->
                  <div id="dolar-conversor" class="text-end my-3">
              <span style="font-weight: 600; color: #333;"> <strong id="dolar-valor"></strong> </span>
              <button id="toggle-moneda" class="btn btn-dark btn-sm ms-3" style="border-radius: 20px; padding: 6px 16px;">
                Mostrar en USD
              </button>
            </div>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="navbar-nav ml-auto d-flex align-items-center">
                <li class="nav-item active">
                  <a class="nav-link" href="{% url 'index' %}">Inicio <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="{% url 'nosotros' %}">Sobre Nosotros</a>
                </li>
                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownProductos" role="button"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Productos
                  </a>
                  <div class="dropdown-menu" aria-labelledby="navbarDropdownProductos">
                    <a class="dropdown-item" href="#peluches">Peluches</a>
                    <a class="dropdown-item" href="#botellas">Botellas</a>
                    <a class="dropdown-item" href="#termos">Termos</a>
                    <a class="dropdown-item" href="#pines">Pines</a>
                    <a class="dropdown-item" href="#llaveros">Llaveros</a>
                    <a class="dropdown-item" href="#lamparas">L√°mparas</a>
                  </div>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="contact.html">Contacta con Nosotros</a>
                </li>
              </ul>
              <div class="quote_btn-container d-flex align-items-center ml-3">
                <form class="form-inline" id="searchForm">
                  <input type="text" class="form-control" placeholder="Buscar..." id="searchInput" />
                  <button class="btn nav_search-btn" type="submit">
                    <i class="fa fa-search" aria-hidden="true"></i>
                  </button>
                </form>
                <a href="{% url 'login' %}" class="ml-3" title="Iniciar sesi√≥n">
          <i class="fa fa-user" aria-hidden="true" style="font-size: 1.5rem;"></i>
      </a>

<!-- Bot√≥n del Carrito -->
<button type="button" class="ml-3 position-relative cart-icon" style="background: none; border: none; padding: 0; cursor: pointer;" title="Ver carrito">
  <i class="fas fa-shopping-cart" style="font-size: 1.5rem; margin-left: -25px; color: black;"></i>
  {% if cart_count > 0 %}
    <span id="cart-count-badge">{{ cart_count }}</span>
  {% endif %}
</button>




    <!-- Modal del Carrito -->
<div id="cartModal" class="cart-modal">
  <div class="cart-modal-content">
    <h2>TU CARRITO</h2>
    <button class="close-button">&times;</button>
    <!-- Lista de productos en el carrito (se llena con JS) -->
    <div class="cart-items" id="cartItemsContainer"></div>
    <div class="cart-total">
      <p>SUBTOTAL: $<span id="subtotal">0.00</span></p>
    </div>
    <div class="cart-footer">
      <a href="{% url 'carrito' %}" class="view-cart-button">VER CARRITO</a>
      <button class="checkout-button" id="checkoutButton">REALIZAR COMPRA</button>
    </div>
  </div>
</div>

   

   
      </header>
      <!-- Fin de Header -->

      <!-- Secci√≥n Peluches -->

    <section id="peluches" class="peluches">
      <h3 style="text-align: center; font-family: Georgia, 'Times New Roman', Times, serif;">Nuestros Peluches</h3>
      <div class="tarjetas-contenedor">
        {% for producto in peluches %}
          <div class="tarjeta producto" data-precio="{{ producto.precio }}">
            <img src="{% static 'images/'|add:producto.imagen %}" alt="{{ producto.nombre }}">
            <h3>{{ producto.nombre }}</h3>
            <p>{{ producto.descripcion }}</p>
            <p class="precio-producto">{{ producto.precio|intcomma }}</p>
            <p>Cantidad: {{ producto.stock_set.first.cantidad }}</p>
            <button onclick="agregarAlCarrito('{{ producto.id_producto }}')">Agregar al carrito</button>
          </div>
        {% endfor %}
      </div>
    </section>

      <br>

      <!-- Secci√≥n Botellas -->
      <section id="botellas" class="botellas">
        <h3 style="text-align: center; font-family: Georgia, 'Times New Roman', Times, serif;">Nuestras Botellas</h3>
        <div class="tarjetas-contenedor">
           {% for producto in botellas %}
              <div class="tarjeta">
                <img src="{% static 'images/'|add:producto.imagen %}" alt="{{ producto.nombre }}">
                <h3>{{ producto.nombre }}</h3>
                <p>{{ producto.descripcion }}</p>
                <p class="precio-producto">{{ producto.precio|intcomma }}</p>
                <p>Cantidad: {{ producto.stock_set.first.cantidad }}</p>
                <button onclick="agregarAlCarrito('{{ producto.id_producto }}')">Agregar al carrito</button>
              </div>
          {% endfor %}
        </div>
      </section>

      <br>

      <!-- Secci√≥n Termos -->
      <section id="termos" class="termos">
        <h3 style="text-align: center; font-family: Georgia, 'Times New Roman', Times, serif;">Nuestros Termos</h3>
        <div class="tarjetas-contenedor">
           {% for producto in termos %}
              <div class="tarjeta">
                <img src="{% static 'images/'|add:producto.imagen %}" alt="{{ producto.nombre }}">
                <h3>{{ producto.nombre }}</h3>
                <p>{{ producto.descripcion }}</p>
                <p>$ {{ producto.precio | intcomma }}</p>
                <p>Cantidad: {{ producto.stock_set.first.cantidad }}</p>
                <button onclick="agregarAlCarrito('{{ producto.id_producto }}')">Agregar al carrito</button>
              </div>
          {% endfor %}
        </div>
      </section>

      <br>

      <!-- Secci√≥n Pines -->
      <section id="pines" class="pines">
        <h3 style="text-align: center; font-family: Georgia, 'Times New Roman', Times, serif;">Nuestros Pines</h3>
        <div class="tarjetas-contenedor">
             {% for producto in pines %}
              <div class="tarjeta">
                <img src="{% static 'images/'|add:producto.imagen %}" alt="{{ producto.nombre }}">
                <h3>{{ producto.nombre }}</h3>
                <p>{{ producto.descripcion }}</p>
                <p>$ {{ producto.precio | intcomma }}</p>
                <p>Cantidad: {{ producto.stock_set.first.cantidad }}</p>
                <button onclick="agregarAlCarrito('{{ producto.id_producto }}')">Agregar al carrito</button>
              </div>
          {% endfor %}
        </div>
      </section>

      <br>

      <!-- Secci√≥n Llaveros -->
      <section id="llaveros" class="llaveros">
        <h3 style="text-align: center; font-family: Georgia, 'Times New Roman', Times, serif;">Nuestros Llaveros</h3>
        <div class="tarjetas-contenedor">
           {% for producto in llaveros %}
              <div class="tarjeta">
                <img src="{% static 'images/'|add:producto.imagen %}" alt="{{ producto.nombre }}">
                <h3>{{ producto.nombre }}</h3>
                <p>{{ producto.descripcion }}</p>
                <p>$ {{ producto.precio | intcomma }}</p>
                <p>Cantidad: {{ producto.stock_set.first.cantidad }}</p>
                <button onclick="agregarAlCarrito('{{ producto.id_producto }}')">Agregar al carrito</button>
              </div>
          {% endfor %}
        </div>
      </section>

      <br>

      <!-- Secci√≥n L√°mparas -->
      <section id="lamparas" class="lamparas">
        <h3 style="text-align: center; font-family: Georgia, 'Times New Roman', Times, serif;">Nuestras L√°mparas</h3>
        <div class="tarjetas-contenedor">
           {% for producto in lamparas %}
              <div class="tarjeta">
                <img src="{% static 'images/'|add:producto.imagen %}" alt="{{ producto.nombre }}">
                <h3>{{ producto.nombre }}</h3>
                <p>{{ producto.descripcion }}</p>
                <p>$ {{ producto.precio | intcomma }}</p>
                <p>Cantidad: {{ producto.stock_set.first.cantidad }}</p>
                <button onclick="agregarAlCarrito('{{ producto.id_producto }}')">Agregar al carrito</button>
              </div>
          {% endfor %}
        </div>
      </section>

      <!-- Info Section -->
      <section class="info_section layout_padding2">
        <div class="container">
          <div class="row info_main_row">
            <div class="col-md-6 col-lg-3">
              <div class="info_links">
                <h4>Men√∫</h4>
                <div class="info_links_menu">
                  <a href="{% url 'index' %}">Inicio</a>
                  <a href="{% url 'nosotros' %}">Acerca de Nosotros</a>
                  <a href="{% url 'productos' %}">Productos</a>
                  <a href="testimonial.html">Cont√°ctanos</a>
                </div>
              </div>
            </div>
            <div class="col-md-6 col-lg-3">
              <div class="info_detail">
                <h4>Compa√±√≠a</h4>
                <p class="mb-0">
                  SanrioDreams es una tienda online dedicada a ofrecer productos originales de Sanrio a precios accesibles.
                </p>
              </div>
            </div>
            <div class="col-md-6 col-lg-3">
              <h4>Contacto</h4>
              <div class="info_contact">
                <a href=""><i class="fa fa-phone"></i><span>+56 9 xxxx xxxx</span></a>
                <a href=""><i class="fa fa-envelope"></i><span>sanriodreams@sanriodreams.cl</span></a>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Footer -->
      <footer class="container-fluid footer_section">
        <div class="container">
          <div class="col-md-11 col-lg-8 mx-auto">
            <p>&copy; <span id="displayYear"></span> Todos los derechos reservados a <a href="#">SanrioDreams</a></p>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <style>
    /* Estilo general para las tarjetas */
.tarjeta {
  display: flex;
  flex-direction: column; /* Alinea los elementos verticalmente */
  align-items: center; /* Centra horizontalmente los elementos */
  border: 1px solid #ccc;
  padding: 10px;
  margin: 10px;
  text-align: center;
}

/* Estilo para la imagen */
.tarjeta img {
  max-width: 100%;
  height: auto;
  margin-bottom: 10px;
}

/* Estilo para el t√≠tulo */
.tarjeta h3 {
  margin: 0;
}

/* Estilo para la descripci√≥n */
.tarjeta p {
  margin: 5px 0;
}

/* Estilo para la informaci√≥n (precio y cantidad) */
.info {
  display: flex;
  justify-content: space-between; /* Distribuye los elementos horizontalmente */
  width: 100%; /* Asegura que ocupe todo el ancho de la tarjeta */
  margin-bottom: 10px;
}

/* Estilo para el bot√≥n */
.tarjeta button {
  background-color: pink;
  color: white;
  border: none;
  padding: 10px 20px;
  cursor: pointer;
  border-radius: 5px;
}
  </style>

  <!-- Script para b√∫squeda -->
  <script>
    document.getElementById('searchForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const searchInput = document.getElementById('searchInput');
      const searchTerm = searchInput.value.trim().toLowerCase();

      const sectionMap = {
        'todos': 'productos',
        'peluche': 'peluches',
        'mu√±eco': 'peluches',
        'figura': 'peluches',
        'stuffed': 'peluches',
        'peluchito': 'peluches',
        'juguete': 'peluches',
        'botella': 'botellas',
        'vaso': 'botellas',
        'taza': 'botellas',
        'botellita': 'botellas',
        'bid√≥n': 'botellas',
        'cantimplora': 'botellas',
        'termo': 'termos',
        'thermos': 'termos',
        'termico': 'termos',
        'termo de caf√©': 'termos',
        'vaso t√©rmico': 'termos',
        'mug t√©rmico': 'termos',
        'pin': 'pines',
        'sticker': 'pines',
        'pegatina': 'pines',
        'calcoman√≠a': 'pines',
        'insignia': 'pines',
        'chapita': 'pines',
        'llavero': 'llaveros',
        'keychain': 'llaveros',
        'llave': 'llaveros',
        'adorno de llave': 'llaveros',
        'colgante': 'llaveros',
        'lampara': 'lamparas',
        'luz': 'lamparas',
        'luminaria': 'lamparas',
        'foco decorativo': 'lamparas',
        'led': 'lamparas',
        'night light': 'lamparas'
      };

      for (const [key, value] of Object.entries(sectionMap)) {
        if (searchTerm.includes(key)) {
          const targetElement = document.getElementById(value);
          if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth' });
            return;
          }
        }
      }
      alert("No se encontr√≥ la categor√≠a.");
    });
let valorDolar = null; // Valor del d√≥lar en CLP (1 USD = X CLP)
let mostrandoDolares = false;

// Obtener el valor del d√≥lar desde la API de mindicador.cl
async function obtenerDolar() {
    try {
        const res = await fetch('https://mindicador.cl/api/dolar');
        const data = await res.json();
        return data.serie[0].valor;
    } catch (e) {
        console.error("No se pudo obtener el valor del d√≥lar:", e);
        return null;
    }
}

// Formatear precios
function formatearCLP(valor) {
    return '$' + valor.toLocaleString('es-CL') + ' CLP';
}
function formatearUSD(valor) {
    return '$' + valor.toFixed(2) + ' USD';
}

// Actualizar precios seg√∫n la moneda seleccionada
function actualizarPrecios() {
    const productos = document.querySelectorAll('.producto');
    productos.forEach(producto => {
        const precioCLP = Number(producto.dataset.precio);
        const precioElem = producto.querySelector('.precio-producto');
        if (mostrandoDolares && valorDolar) {
            // Convertir de CLP a USD: precioCLP / valorDolar
            const precioUSD = precioCLP / valorDolar;
            precioElem.textContent = formatearUSD(precioUSD);
        } else {
            precioElem.textContent = formatearCLP(precioCLP);
        }
    });
}

// Evento al cargar la p√°gina
document.addEventListener('DOMContentLoaded', async () => {
    valorDolar = await obtenerDolar();
    if (valorDolar) {
        document.getElementById('dolar-valor').textContent = `1 USD ‚âà $${Math.round(valorDolar).toLocaleString('es-CL')} CLP`;
    } else {
        document.getElementById('dolar-valor').textContent = "Error al cargar USD";
    }

    actualizarPrecios();

    document.getElementById('toggle-moneda').addEventListener('click', () => {
        mostrandoDolares = !mostrandoDolares;
        document.getElementById('toggle-moneda').textContent = mostrandoDolares ? 'Mostrar en CLP' : 'Mostrar en USD';
        actualizarPrecios();
    });
});
 


 // Obtener token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    // Funci√≥n para abrir el modal del carrito
   function abrirModalCarrito() {
    const cartModal = document.getElementById('cartModal');
    if (cartModal) {
        obtenerYMostrarCarrito(); // <-- Esto actualiza el contenido antes de mostrar
        cartModal.classList.add('open');
        cartModal.style.display = 'block'; // Si usas display:block para mostrar
    }
}

// Cerrar el modal del carrito
document.addEventListener('DOMContentLoaded', function() {
    const closeButton = document.querySelector('.close-button');
    const cartModal = document.getElementById('cartModal');
    if (closeButton && cartModal) {
        closeButton.addEventListener('click', function() {
            cartModal.style.display = 'none';
        });
    }
    // Abrir modal al hacer click en el icono del carrito
   const cartIcon = document.querySelector('.cart-icon');
if (cartIcon) {
    cartIcon.addEventListener('click', abrirModalCarrito);
}
});

document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('cartItemsContainer').addEventListener('click', function(e) {
    const btn = e.target;
    const cartItem = btn.closest('.cart-item');
    if (!cartItem) return;
    const id = cartItem.getAttribute('data-id');
    const cantidadElem = cartItem.querySelector('.item-cantidad');
    let cantidad = Number(cantidadElem.textContent);

    // Si tienes stock m√°ximo, puedes agregarlo como data-stock en el backend y leerlo aqu√≠
    const stockMax = Number(cartItem.dataset.stock) || 99;

    if (btn.classList.contains('aumentar')) {
      if (cantidad < stockMax) {
        fetch(`/carrito/aumentar/${id}/`, {method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}})
          .then(() => obtenerYMostrarCarrito());
      } else {
        alert('No puedes agregar m√°s de lo disponible en stock.');
      }
    }
    if (btn.classList.contains('disminuir')) {
      if (cantidad > 1) {
        fetch(`/carrito/disminuir/${id}/`, {method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}})
          .then(() => obtenerYMostrarCarrito());
      } else {
        // Si la cantidad es 1 y presionan menos, elimina el producto (pero NO cierres el modal)
        fetch(`/carrito/quitar/${id}/`, {method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}})
          .then(() => obtenerYMostrarCarrito());
      }
    }
    if (btn.classList.contains('eliminar')) {
      fetch(`/carrito/quitar/${id}/`, {method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}})
        .then(() => obtenerYMostrarCarrito());
    }
  });
});

    // Funci√≥n para actualizar el contador del carrito
  function actualizarContadorCarrito(carrito) {
    const cartCountBadge = document.getElementById('cart-count-badge');
    let count = 0;
    if (Array.isArray(carrito)) {
        carrito.forEach(item => count += Number(item.cantidad));
    }
    if (cartCountBadge) {
        cartCountBadge.textContent = count;
        cartCountBadge.style.display = count > 0 ? 'inline-block' : 'none';
    }
}


    // Funci√≥n para agregar un producto al carrito
function agregarAlCarrito(id_producto) {
    const url = `/agregar-al-carrito/${id_producto}/`;
    const csrftoken = getCookie('csrftoken');
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            obtenerYMostrarCarrito();
            abrirModalCarrito();
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    })
    .catch(err => {
        alert('Hubo un problema al agregar el producto. Revisa la consola.');
    });
}

    // Funci√≥n para obtener y mostrar el carrito
   function obtenerYMostrarCarrito() {
    fetch('/obtener-carrito/', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.carrito) {
            const carrito = data.carrito;
            actualizarCarritoModal(carrito);
            actualizarContadorCarrito(carrito);
        }
    })
    .catch(err => {
        console.error('üö® Error al obtener el carrito:', err);
    });
}
    // Cargar el carrito al cargar la p√°gina
    window.onload = function () {
        obtenerYMostrarCarrito();
    };

  function actualizarCarritoModal(carrito) {
    const cartItemsContainer = document.getElementById('cartItemsContainer');
    cartItemsContainer.innerHTML = '';
    if (!Array.isArray(carrito) || carrito.length === 0) {
        cartItemsContainer.innerHTML = '<p class="empty-cart">El carrito est√° vac√≠o.</p>';
        document.getElementById('subtotal').textContent = '0.00';
        return;
    }
    carrito.forEach(item => {
        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        cartItem.dataset.id = item.id;
        cartItem.dataset.stock = item.stock || 99; // Aseg√∫rate que tu backend env√≠a 'stock'

        cartItem.innerHTML = `
            <img src="/static/images/${item.imagen}" alt="${item.nombre}" class="cart-item-image">
            <div class="cart-item-details">
                <h3>${item.nombre}</h3>
                <p>Precio: $<span class="item-precio">${item.precio}</span></p>
                <p>Cantidad: <span class="item-cantidad">${item.cantidad}</span></p>
                <p>Subtotal: $<span class="item-subtotal">${Number(item.subtotal).toFixed(2)}</span></p>
            </div>
            <div class="cart-item-actions">
                <button class="action-button aumentar">+</button>
                <button class="action-button disminuir">-</button>
                <button class="action-button eliminar">Eliminar</button>
            </div>
        `;
        cartItemsContainer.appendChild(cartItem);
    });
    // Actualizar total
    const subtotalTotal = carrito.reduce((acc, item) => acc + Number(item.subtotal), 0);
    const totalElement = document.getElementById('subtotal');
    if (totalElement) {
        totalElement.textContent = subtotalTotal.toFixed(2);
    }
}

  </script>

  <!-- Scripts -->
 <script src="https://cdn.jsdelivr.net/npm/@formatjs/intl-numberformat-polyfill@4/dist/formatjs-intl-numberformat.min.js"></script> 
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script> 
  <script src="{% static 'js/custom.js' %}"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"> 




  <script>
</script>


</body>
</html>