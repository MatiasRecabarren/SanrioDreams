{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Administraci√≥n - Usuarios</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"  rel="stylesheet">

    <!-- Estilos personalizados -->
    <style>
        body {
            background-color: #fffaf9;
            font-family: 'Segoe UI', sans-serif;
        }

        h2 {
            color: #d63384;
            font-weight: bold;
        }

        .card {
            border: none;
            box-shadow: 0 4px 12px rgba(214, 51, 132, 0.1);
        }

        .card-header {
            background-color: #f8d7da;
            color: #842029;
            font-weight: bold;
        }

        .form-control:focus {
            border-color: #d63384;
            box-shadow: 0 0 0 0.2rem rgba(214, 51, 132, 0.25);
        }

        .btn-primary {
            background-color: #d63384;
            border: none;
        }

        .btn-success {
            background-color: #9effc8;
            color: #000;
            border: none;
        }

        .btn-warning {
            background-color: #ffe08a;
            color: #000;
            border: none;
        }

        .btn-danger {
            background-color: #f59fb4;
            border: none;
        }

        table th {
            background-color: #fcd5ce;
            color: #be2b69;
        }

        .table-bordered td,
        .table-bordered th {
            border: 1px solid #fcd5ce;
        }
    </style>
</head>
<body class="container mt-4">

    <h2 class="text-center mb-4">üå∏ Panel de Administraci√≥n - Usuarios</h2>

    <!-- Formulario de Registro -->
    <div class="card mb-4">
        <div class="card-header text-center">Registrar Nuevo Usuario</div>
        <div class="card-body">
            <form id="registro-form" class="row g-3">
                <div class="col-md-6">
                    <label for="id_usuario" class="form-label">RUT</label>
                    <input type="text" class="form-control" id="id_usuario" name="id_usuario"
                        placeholder="Ej: 12345678-9" required>
                </div>

                <div class="col-md-6">
                    <label for="nombre" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="nombre" name="nombre"
                        placeholder="Ingresa tu nombre" required>
                </div>

                <div class="col-md-6">
                    <label for="apellido" class="form-label">Apellido</label>
                    <input type="text" class="form-control" id="apellido" name="apellido"
                        placeholder="Ingresa tu apellido" required>
                </div>

                <div class="col-md-6">
                    <label for="correo" class="form-label">Correo electr√≥nico</label>
                    <input type="email" class="form-control" id="correo" name="correo"
                        placeholder="ejemplo@correo.com" required>
                </div>

                <div class="col-md-6">
                    <label for="contrasenna" class="form-label">Contrase√±a</label>
                    <input type="password" class="form-control" id="contrasenna" name="contrasenna"
                        placeholder="M√≠nimo 8 caracteres" required>
                </div>

                <div class="col-md-6">
                    <label for="confirm-contra" class="form-label">Confirmar Contrase√±a</label>
                    <input type="password" class="form-control" id="confirm-contra" name="confirm-contra"
                        placeholder="Repite tu contrase√±a" required>
                </div>

                <div class="col-md-6">
                    <label for="direccion" class="form-label">Direcci√≥n</label>
                    <input type="text" class="form-control" id="direccion" name="direccion"
                        placeholder="Ingresa tu direcci√≥n" required>
                </div>

                <div class="col-md-6">
                    <label for="telefono" class="form-label">Tel√©fono</label>
                    <input type="text" class="form-control" id="telefono" name="telefono"
                        placeholder="Ej: 912345678" required>
                </div>

                <div class="col-md-6">
                    <label for="rol" class="form-label">Rol</label>
                    <select class="form-select" id="rol" name="rol" required>
                        <option value="">Selecciona un rol</option>
                        <option value="cliente">Cliente</option>
                        <option value="empleado">Empleado</option>
                        <option value="bodeguero">Bodeguero</option>
                        <option value="contador">Contador</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>

                <div class="col-12 d-grid">
                    <button type="submit" class="btn btn-success btn-lg mt-3">Registrar Usuario</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de Usuarios -->
    <div class="card mb-4">
        <div class="card-header text-center">Lista de Usuarios</div>
        <div class="card-body">
            <table class="table table-bordered table-striped" id="usuarios-tabla">
                <thead>
                    <tr>
                        <th>RUT</th>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Correo</th>
                        <th>Tel√©fono</th>
                        <th>Rol</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Aqu√≠ se cargar√°n los usuarios din√°micamente -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Gesti√≥n de Productos -->
<div class="card mb-4">
  <div class="card-header text-center">Gestionar Productos</div>
  <div class="card-body">
    <form id="producto-form" class="row g-3">
      <input type="hidden" id="id_producto" name="id_producto">
      <div class="col-md-6">
        <label for="nombre_producto" class="form-label">Nombre</label>
        <input type="text" class="form-control" id="nombre_producto" name="nombre" required>
      </div>
      <div class="col-md-6">
        <label for="precio_producto" class="form-label">Precio</label>
        <input type="number" class="form-control" id="precio_producto" name="precio" min="0" required>
      </div>
      <div class="col-md-12">
        <label for="descripcion_producto" class="form-label">Descripci√≥n</label>
        <textarea class="form-control" id="descripcion_producto" name="descripcion" required></textarea>
      </div>
      <div class="col-md-6">
        <label for="imagen_producto" class="form-label">Imagen (URL)</label>
        <input type="text" class="form-control" id="imagen_producto" name="imagen" required>
      </div>
      <div class="col-md-6">
        <label for="disponible_producto" class="form-label">Disponible</label>
        <select class="form-select" id="disponible_producto" name="disponible" required>
          <option value="1">S√≠</option>
          <option value="0">No</option>
        </select>
      </div>
      <div class="col-12 d-grid">
        <button type="submit" class="btn btn-success btn-lg mt-3" id="btn-producto">Registrar Producto</button>
      </div>
    </form>
  </div>
</div>


<!-- Mostrar productos de la base de datos (Django) -->
<div class="card mb-4">
  <div class="card-header text-center">Gesti√≥n de Productos</div>
  <div class="card-body">
    <table class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Descripci√≥n</th>
          <th>Precio</th>
          <th>Imagen</th>
          <th>Disponible</th>
        </tr>
      </thead>
      <tbody>
        {% for producto in productos %}
        <tr>
          <td>{{ producto.id_producto }}</td>
          <td>{{ producto.nombre }}</td>
          <td>{{ producto.descripcion }}</td>
          <td>${{ producto.precio}}</td>
          <td>
            {% if producto.imagen %}
              <img src="{% static 'images/'|add:producto.imagen %}" alt="img" style="width:50px;height:50px;object-fit:cover;">
            {% else %}
              Sin imagen
            {% endif %}
          </td>
          <td>{{ producto.disponible|yesno:"S√≠,No" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center">No hay productos en la base de datos.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
const PRODUCT_API_URL = "http://localhost:3000/producto";
const PRODUCT_API_KEY = "llaveparaapy11.";

async function cargarProductos() {
  try {
    const res = await fetch(PRODUCT_API_URL, {
      headers: { "x-api-key": PRODUCT_API_KEY }
    });
    if (!res.ok) throw new Error("Error al cargar productos");
    const productos = await res.json();
    mostrarProductos(productos);
  } catch (err) {
    document.querySelector("#productos-tabla tbody").innerHTML =
      `<tr><td colspan="7" class="text-center">‚ö†Ô∏è Error al cargar productos</td></tr>`;
  }
}

function mostrarProductos(productos) {
  const tbody = document.querySelector("#productos-tabla tbody");
  tbody.innerHTML = "";
  if (!productos.length) {
    tbody.innerHTML = `<tr><td colspan="7" class="text-center">No hay productos</td></tr>`;
    return;
  }
  productos.forEach(prod => {
    tbody.innerHTML += `
      <tr>
        <td>${prod.id_producto}</td>
        <td>${prod.nombre}</td>
        <td>${prod.descripcion}</td>
        <td>$${prod.precio}</td>
        <td><img src="${prod.imagen}" alt="img" style="width:50px;height:50px;object-fit:cover;"></td>
        <td>${prod.disponible ? "S√≠" : "No"}</td>
        <td>
          <button class="btn btn-warning btn-sm" onclick="editarProducto('${prod.id_producto}')">Editar</button>
          <button class="btn btn-danger btn-sm" onclick="eliminarProducto('${prod.id_producto}')">Eliminar</button>
        </td>
      </tr>
    `;
  });
}

document.getElementById("producto-form").onsubmit = async function(e) {
  e.preventDefault();
  const id = document.getElementById("id_producto").value;
  const nombre = document.getElementById("nombre_producto").value;
  const descripcion = document.getElementById("descripcion_producto").value;
  const precio = document.getElementById("precio_producto").value;
  const imagen = document.getElementById("imagen_producto").value;
  const disponible = document.getElementById("disponible_producto").value;

  const data = { nombre, descripcion, precio, imagen, disponible };
  let url = PRODUCT_API_URL;
  let method = "POST";
  if (id) {
    url += "/" + id;
    method = "PUT";
  }

  try {
    const res = await fetch(url, {
      method,
      headers: {
        "Content-Type": "application/json",
        "x-api-key": PRODUCT_API_KEY
      },
      body: JSON.stringify(data)
    });
    if (!res.ok) throw new Error("Error al guardar producto");
    cargarProductos();
    this.reset();
    document.getElementById("btn-producto").textContent = "Registrar Producto";
    document.getElementById("id_producto").value = "";
  } catch (err) {
    alert("‚ùå Error al guardar producto");
  }
};

async function editarProducto(id) {
  try {
    const res = await fetch(PRODUCT_API_URL + "/" + id, {
      headers: { "x-api-key": PRODUCT_API_KEY }
    });
    if (!res.ok) throw new Error("Error al obtener producto");
    const prod = await res.json();
    document.getElementById("id_producto").value = prod.id_producto;
    document.getElementById("nombre_producto").value = prod.nombre;
    document.getElementById("descripcion_producto").value = prod.descripcion;
    document.getElementById("precio_producto").value = prod.precio;
    document.getElementById("imagen_producto").value = prod.imagen;
    document.getElementById("disponible_producto").value = prod.disponible;
    document.getElementById("btn-producto").textContent = "Actualizar Producto";
  } catch (err) {
    alert("‚ùå Error al cargar producto");
  }
}

async function eliminarProducto(id) {
  if (!confirm("¬øEliminar producto?")) return;
  try {
    const res = await fetch(PRODUCT_API_URL + "/" + id, {
      method: "DELETE",
      headers: { "x-api-key": PRODUCT_API_KEY }
    });
    if (!res.ok) throw new Error("Error al eliminar producto");
    cargarProductos();
  } catch (err) {
    alert("‚ùå Error al eliminar producto");
  }
}

// Inicializar productos al cargar la p√°gina
document.addEventListener("DOMContentLoaded", cargarProductos);
</script>

    <!-- Cargar admin.js -->
    <script src="{% static 'js/admin.js' %}"></script>


</body>
</html>

